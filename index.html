<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>RSIvsCena</title>
  <style>
    /* Styl modalnego okna */
    #loginModal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0; width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    #loginModal .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      position: relative;
    }
    #loginModal .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    /* Ukrywanie chronionych zakładek domyślnie */
    .protected {
      display: none;
    }
  </style>
</head>
<body>

<!-- Przycisk do wywołania modala -->
<button id="loginBtn">Zaloguj / Zarejestruj</button>

<!-- Modal logowania/rejestracji -->
<div id="loginModal" style="display: flex;">
  <div class="modal-content">
    <span class="close">&times;</span>

    <!-- Formularz logowania -->
    <div id="loginFormContainer">
      <form id="loginForm">
        <h2>Logowanie</h2>
        <input id="loginEmail" type="email" placeholder="E-mail" required /><br /><br />
        <input id="loginPassword" type="password" placeholder="Hasło" required /><br /><br />
        <button type="submit">Zaloguj</button>
      </form>
      <p>
        Nie masz konta? <a href="#" id="showRegister">Zarejestruj się</a>
      </p>
    </div>

    <!-- Formularz rejestracji -->
    <div id="registerFormContainer" style="display: none;">
      <form id="registerForm">
        <h2>Rejestracja</h2>
        <input id="name" type="text" placeholder="Imię i nazwisko" required /><br /><br />
        <input id="email" type="email" placeholder="E-mail" required /><br /><br />
        <button type="submit">Zarejestruj</button>
      </form>
      <p>
        Masz konto? <a href="#" id="showLogin">Zaloguj się</a>
      </p>
    </div>

  </div>
</div>

<script>
  const modal = document.getElementById("loginModal");
  const closeBtn = document.querySelector(".close");
  const loginBtn = document.getElementById("loginBtn");
  const loginForm = document.getElementById("loginForm");
  const registerForm = document.getElementById("registerForm");
  const loginFormContainer = document.getElementById("loginFormContainer");
  const registerFormContainer = document.getElementById("registerFormContainer");

  // Pokazuj modal po kliknięciu "Zaloguj / Zarejestruj"
  loginBtn.onclick = () => {
    modal.style.display = "flex";
    showLogin();
  };

  closeBtn.onclick = () => modal.style.display = "none";
  window.onclick = (event) => { if (event.target == modal) modal.style.display = "none"; }

  // Przełączniki formularzy
  function showRegister() {
    loginFormContainer.style.display = "none";
    registerFormContainer.style.display = "block";
  }

  function showLogin() {
    loginFormContainer.style.display = "block";
    registerFormContainer.style.display = "none";
  }

  document.getElementById("showRegister").onclick = (e) => {
    e.preventDefault();
    showRegister();
  };
  document.getElementById("showLogin").onclick = (e) => {
    e.preventDefault();
    showLogin();
  };

  // Obsługa rejestracji
  registerForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();

    if (!name || !email) {
      alert("Proszę wypełnić wszystkie pola.");
      return;
    }

    try {
      const response = await fetch("https://rvc-new-backend.onrender.com/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, email })
      });
      const data = await response.json();
      if (response.ok) {
        alert("Zgłoszenie wysłane! Oczekuj na akceptację i kod jednorazowy e-mailem.");
        showLogin(); // Po rejestracji wróć do logowania
      } else {
        alert(data.message || "Wystąpił błąd podczas rejestracji.");
      }
    } catch (error) {
      alert("Błąd sieci lub serwera: " + error.message);
    }
  });

  // Obsługa logowania
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value;

    if (!email || !password) {
      alert("Proszę podać e-mail i hasło.");
      return;
    }

    try {
      const response = await fetch("https://rvc-new-backend.onrender.com/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
      });
      const data = await response.json();
      if (response.ok) {
        localStorage.setItem("token", data.token);
        localStorage.setItem("mustChangePassword", data.mustChangePassword);
        alert("Zalogowano!" + (data.mustChangePassword ? " Musisz ustawić nowe hasło." : ""));
        modal.style.display = "none";
        // Pokazuj chronione zakładki po zalogowaniu
        document.querySelectorAll(".protected").forEach(el => el.style.display = "inline");

        // Jeśli trzeba zmienić hasło, przekieruj na stronę resetu
        if (data.mustChangePassword) {
          window.location.href = "reset.html"; // później przygotujemy tę stronę
        }
      } else {
        alert(data.message || "Błąd logowania");
      }
    } catch (error) {
      alert("Błąd sieci lub serwera: " + error.message);
    }
  });

  // Po załadowaniu strony sprawdź czy użytkownik jest zalogowany i pokaż chronione zakładki
  window.addEventListener("DOMContentLoaded", () => {
    const token = localStorage.getItem("token");
    if (token) {
      document.querySelectorAll(".protected").forEach(el => el.style.display = "inline");
    } else {
      // Domyślnie ukryj chronione zakładki
      document.querySelectorAll(".protected").forEach(el => el.style.display = "none");
    }
  });
</script>

</body>
</html>
